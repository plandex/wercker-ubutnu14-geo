name: ubuntu14-ruby-geo
version: 0.1.4
inherits: ruudk/ubuntu14.04@1.0.0
type: main
platform: ubuntu@12.04
no-response-timeout: 10
description: |
  Wercker box with Ubuntu 12.04 upgraded to Ubuntu 14.04, heroku cedar-14
  packages installed, ruby 2.1.5 via rbenv, postgres 9.3 with postgis support.
  GEOS and PROJ libraries available for rgeo gem. This box provides basic
  environment for ruby geo applications.
keywords:
  - geo
  - ruby
  - postgis
  - geos
packages:
  - postgresql@9.3
  - postgis@2.1
  - geos@3.4.2
  - proj@4.8.0
script: |
  sudo apt-get update -y
  sudo apt-get install -y --force-yes postgresql-9.3-postgis-2.1 autoconf bind9-host bison build-essential coreutils curl daemontools dnsutils ed git imagemagick iputils-tracepath language-pack-en libbz2-dev libcurl4-openssl-dev libevent-dev libglib2.0-dev libjpeg-dev libmagickwand-dev libncurses5-dev libpq-dev libpq5 libreadline6-dev libssl-dev libxml2-dev libxslt-dev netcat-openbsd openssh-client openssh-server postgresql-server-dev-9.3 python python-dev ruby ruby-dev socat syslinux tar telnet zip zlib1g-dev
  if sudo grep -Exq '^local\s+all\s+postgres\s+\w+' /etc/postgresql/9.3/main/pg_hba.conf; then sudo sed -i -r -e 's/local\s+all\s+postgres\s+\w+/local all postgres  trust/' /etc/postgresql/9.3/main/pg_hba.conf; else sudo -- sh -c "echo 'local all postgres  trust' >> /etc/postgresql/9.3/main/pg_hba.conf"; fi
  echo 'restarting postgresql 9.3 to ensure that configuration is correct'
  sudo service postgresql restart
  cd / && sudo rm -rf /var/cache/apt/archives/*.deb
  curl -sL https://s3-us-west-2.amazonaws.com/plandex-heroku/cedar-14/proj-4.8.0-1.tar.gz -o /tmp/proj.tar.gz
  curl -sL https://s3-us-west-2.amazonaws.com/plandex-heroku/cedar-14/geos-3.4.2-1.tar.gz -o /tmp/geos.tar.gz
  sudo tar -zxf /tmp/proj.tar.gz -C /usr
  sudo tar -zxf /tmp/geos.tar.gz -C /usr
  sudo ldconfig
  git clone https://github.com/sstephenson/rbenv.git ~/.rbenv
  git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build
  echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
  echo 'eval "$(rbenv init -)"' >> ~/.bashrc
  export PATH="$HOME/.rbenv/bin:$PATH"
  rbenv init -
  rbenv install 2.1.5
  rbenv rehash
  rbenv global 2.1.5
  ~/.rbenv/shims/ruby --version
  ~/.rbenv/shims/gem install bundler --no-rdoc --no-ri
  ~/.rbenv/shims/gem install rgeo --no-rdoc --no-ri
  ~/.rbenv/shims/ruby -e 'require "rgeo";puts "RGeo GEOS supported: #{RGeo::Geos.supported? ? "yes":"no"}"'
  rm -rf /tmp/*
